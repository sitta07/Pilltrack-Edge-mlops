stages:
  prepare:
    cmd: python src/prepare.py
    deps:
      - src/prepare.py
      - data/pills_dataset_resnet.zip
    outs:
      - data/raw:
          cache: false  # ðŸ‘ˆ à¹€à¸žà¸´à¹ˆà¸¡à¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰! à¸šà¸­à¸ DVC à¸§à¹ˆà¸²à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸¢à¸¸à¹ˆà¸‡à¸à¸±à¸š S3 à¸ªà¸³à¸«à¸£à¸±à¸šà¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œà¸™à¸µà¹‰
  train:
    cmd: python src/training/train.py
    deps:
      - data/pills_dataset_resnet.zip
      - src/training/train.py
    params:
      - params.yaml:
        - train.epochs
        - train.lr
        - train.batch_size
        - train.temperature
        - train.alpha
        - model.num_classes
        - data.extract_path
    outs:
      - models/best_student.pth  # Output: PyTorch Weights

  # --- STAGE 2: CONVERSION & QC (à¸šà¸µà¸šà¸­à¸±à¸”à¹à¸¥à¸°à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸¸à¸“à¸ à¸²à¸ž) ---
  convert:
    cmd: python src/conversion/convert.py
    deps:
      - models/best_student.pth  # Input: à¸ˆà¸²à¸ Stage train
      - src/conversion/convert.py
    params:
      - params.yaml:
        - evaluation.min_accuracy  # Gatekeeper Threshold
        - data.extract_path        # à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸Šà¹‰à¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›à¸ªà¸³à¸«à¸£à¸±à¸š Evaluation
    outs:
      - models/student_quant_int8.tflite # Output: TFLite Model (Int8)

  # --- STAGE 3: ENROLLMENT & DEPLOYMENT (à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸§à¸²à¸¡à¸—à¸£à¸‡à¸ˆà¸³à¹à¸¥à¸°à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”) ---
  enroll:
    cmd: python src/enrollment/enroll.py
    deps:
      - models/student_quant_int8.tflite # Input: à¸ˆà¸²à¸ Stage convert
      - src/enrollment/enroll.py
      - data/raw                         # Input: à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸¹à¸›à¸ à¸²à¸žà¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¸£à¹‰à¸²à¸‡ Index
    params:
      - params.yaml:
        - enrollment.s3_prefix
    outs:
      - models/pill_db.index             # Output: à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ FAISS
      - models/labels.json               # Output: Map ID -> à¸Šà¸·à¹ˆà¸­à¸¢à¸²
