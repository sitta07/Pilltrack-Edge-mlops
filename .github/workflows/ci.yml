name: MLOps Production Pipeline

on:
  push:
    branches:
      - main                # ‡∏£‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ Push ‡πÄ‡∏Ç‡πâ‡∏≤ main (‡πÄ‡∏û‡∏∑‡πà‡∏≠ Deploy)
      - 'feature/**'        # ‡∏£‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ Push ‡πÄ‡∏Ç‡πâ‡∏≤ feature/ ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß (‡πÄ‡∏û‡∏∑‡πà‡∏≠ Test)

  pull_request:
    branches:
      - main                # ‡∏£‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î PR ‡πÄ‡∏Ç‡πâ‡∏≤ main

jobs:
  run_mlops_pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    env:
      IMAGE_NAME: pilltrack-ci-runner
      
    steps:
      # -----------------------------------------------------------
      # 1. SETUP & DATA PREPARATION (Run on Host for Stability)
      # -----------------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python and DVC (Host)
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - run: |
          # ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á DVC ‡πÅ‡∏•‡∏∞ Boto3 (S3 lib) ‡∏ö‡∏ô Host
          # ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏ô‡∏´‡∏ô‡∏π‡∏Ñ‡∏£‡∏≠‡∏ö "dvc[s3]" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô shell error
          pip install "dvc[s3]" boto3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1

      - name: Check & Pull Data (Host)
        run: |
          echo "--- üì° Checking Remote Data Status ---"
          # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå .zip ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡∏ö‡∏ô S3 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          dvc status data/pills_dataset_resnet.zip.dvc -c
          
          echo "--- üì• Pulling Data to Host Workspace ---"
          # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ Docker
          dvc pull
          
          echo "--- ‚úÖ Verifying Downloaded Data ---"
          if [ -f "data/pills_dataset_resnet.zip" ]; then
            echo "Dataset found: $(ls -lh data/pills_dataset_resnet.zip)"
          else
            echo "‚ùå Error: Dataset zip file missing after pull!"
            exit 1
          fi

      # -----------------------------------------------------------
      # 2. BUILD ENVIRONMENT
      # -----------------------------------------------------------
      - name: Build Docker Image
        run: |
          echo "--- üê≥ Building Docker Image ---"
          docker build -t $IMAGE_NAME -f DockerFile .

      # -----------------------------------------------------------
      # 3. EXECUTE PIPELINE INSIDE DOCKER
      # -----------------------------------------------------------
      - name: Run MLOps Pipeline (Build, Validate, Deploy)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          AWS_DEFAULT_REGION: ap-southeast-1
        run: |
          echo "--- üöÄ Starting Production Pipeline in Docker ---"
          
          mkdir -p models mlruns
          
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -e AWS_ACCESS_KEY_ID \
            -e AWS_SECRET_ACCESS_KEY \
            -e MLFLOW_TRACKING_URI \
            -e S3_BUCKET_NAME \
            -e AWS_DEFAULT_REGION \
            -e GITHUB_REF_NAME=${{ github.ref_name }} \
            --user $(id -u):$(id -g) \
            $IMAGE_NAME \
            /bin/bash -c "
              set -e 
              
              # --- PHASE 1: BUILD ARTIFACTS ---
              echo '========================================='
              echo 'üèóÔ∏è  PHASE 1: Building Artifacts (DVC Repro)'
              echo '========================================='
              dvc repro
              
              # --- PHASE 2: VALIDATION ---
              echo '========================================='
              echo 'üîç  PHASE 2: Validating Performance'
              echo '========================================='
              python src/validate.py
              
              # --- PHASE 3: DEPLOYMENT (Main Only) ---
              echo '========================================='
              echo 'üöÄ  PHASE 3: Deployment Check'
              echo '========================================='
              
              if [ \"\$GITHUB_REF_NAME\" == \"main\" ]; then
                  echo \"‚úÖ Current branch is 'main'. Proceeding to Deploy...\"
                  python src/deploy.py
              else
                  echo \"‚ö†Ô∏è Current branch is '\$GITHUB_REF_NAME'.\"
                  echo \"üõë Skipping Deployment to S3 (Artifacts validated but not pushed).\"
              fi
              
              echo 'üéâüéâ MISSION COMPLETE! Pipeline Finished. üéâüéâ'
            "

      # -----------------------------------------------------------
      # 4. POST-PROCESSING (Artifacts & Logs)
      # -----------------------------------------------------------
      - name: Upload Pipeline Artifacts (Logs & Models)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ml-artifacts-${{ github.run_id }}
          path: |
            mlruns/
            models/
            metrics.json
          retention-days: 30

      - name: Notify Success
        if: success()
        run: echo "‚úÖ MLOps Pipeline Deployed Successfully!"

      - name: Notify Failure
        if: failure()
        run: echo "‚ùå Pipeline Failed! Check the logs above."