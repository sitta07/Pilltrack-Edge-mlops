name: MLOps Production Pipeline

on:
  push:
    branches:
      - main                 
      - 'feature/**'        

  pull_request:
    branches:
      - main                

  pull_request:
    branches:
      - main
jobs:
  run_mlops_pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    env:
      IMAGE_NAME: pilltrack-ci-runner
      
    steps:
      # -----------------------------------------------------------
      # 1. SETUP & DATA PREPARATION (Run on Host for Stability)
      # -----------------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python and DVC (Host)
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - run: |
          pip install "dvc[s3]"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1

      - name: Check & Pull Data (Host)
        run: |
          echo "--- üì° Checking Remote Data Status ---"
          # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå .zip ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡∏ö‡∏ô S3 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          dvc status data/pills_dataset_resnet.zip.dvc -c
          
          echo "--- üì• Pulling Data to Host Workspace ---"
          dvc pull
          
          echo "--- ‚úÖ Verifying Downloaded Data ---"
          if [ -f "data/pills_dataset_resnet.zip" ]; then
            echo "Dataset found: $(ls -lh data/pills_dataset_resnet.zip)"
          else
            echo "‚ùå Error: Dataset zip file missing after pull!"
            exit 1
          fi

      # -----------------------------------------------------------
      # 2. BUILD ENVIRONMENT
      # -----------------------------------------------------------
      - name: Build Docker Image
        run: |
          echo "--- üê≥ Building Docker Image ---"
          docker build -t $IMAGE_NAME -f DockerFile .

      # -----------------------------------------------------------
      # 3. EXECUTE PIPELINE INSIDE DOCKER
      #    (Build -> Validate -> Deploy)
      # -----------------------------------------------------------
      - name: Run MLOps Pipeline (Build, Validate, Deploy)
        env:
          # ‡∏™‡πà‡∏á Secrets ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô Container
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          AWS_DEFAULT_REGION: ap-southeast-1
        run: |
          echo "--- üöÄ Starting Production Pipeline in Docker ---"
          
          # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Output ‡∏£‡∏≠‡πÑ‡∏ß‡πâ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Permission Error ‡∏ï‡∏≠‡∏ô Mount)
          mkdir -p models mlruns
          
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -e AWS_ACCESS_KEY_ID \
            -e AWS_SECRET_ACCESS_KEY \
            -e MLFLOW_TRACKING_URI \
            -e S3_BUCKET_NAME \
            -e AWS_DEFAULT_REGION \
            --user $(id -u):$(id -g) \
            $IMAGE_NAME \
            /bin/bash -c "
              set -e # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Error ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
              
              # --- PHASE 1: BUILD ARTIFACTS ---
              # ‡∏£‡∏±‡∏ô dvc.yaml (Train -> Convert -> Enroll)
              # ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏ü‡∏•‡πå .tflite, .index, .json ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤
              echo '========================================='
              echo 'üèóÔ∏è  PHASE 1: Building Artifacts (DVC Repro)'
              echo '========================================='
              dvc repro
              
              # --- PHASE 2: VALIDATION ---
              # ‡∏£‡∏±‡∏ô script ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô dvc.yaml)
              # ‡∏ñ‡πâ‡∏≤ Accuracy ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå Script ‡∏à‡∏∞ exit 1 ‡πÅ‡∏•‡∏∞ Pipeline ‡∏à‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
              echo '========================================='
              echo 'üîç  PHASE 2: Validating Performance'
              echo '========================================='
              python src/validate.py
              
              # --- PHASE 3: DEPLOYMENT ---
              echo 'üöÄ  PHASE 3: Deployment Check'
              echo '========================================='
              
              if [ \"\$GITHUB_REF_NAME\" == \"main\" ]; then
                  echo \"‚úÖ Current branch is 'main'. Proceeding to Deploy...\"
                  python src/deploy.py
              else
                  echo \"‚ö†Ô∏è Current branch is '\$GITHUB_REF_NAME'.\"
                  echo \"üõë Skipping Deployment to S3 (Artifacts validated but not pushed).\"
              fi
              
              echo 'üéâüéâ MISSION COMPLETE! Pipeline Finished. üéâüéâ'
            "

      # -----------------------------------------------------------
      # 4. POST-PROCESSING (Artifacts & Logs)
      # -----------------------------------------------------------
      - name: Upload Pipeline Artifacts (Logs & Models)
        if: always() # ‡πÄ‡∏Å‡πá‡∏ö Log ‡πÄ‡∏™‡∏°‡∏≠ ‡πÅ‡∏°‡πâ Pipeline ‡∏à‡∏∞‡∏û‡∏±‡∏á
        uses: actions/upload-artifact@v4
        with:
          name: ml-artifacts-${{ github.run_id }}
          path: |
            mlruns/
            models/
            metrics.json
          retention-days: 30

      - name: Notify Success
        if: success()
        run: echo "‚úÖ MLOps Pipeline Deployed Successfully!"

      - name: Notify Failure
        if: failure()
        run: echo "‚ùå Pipeline Failed! Check the logs above."